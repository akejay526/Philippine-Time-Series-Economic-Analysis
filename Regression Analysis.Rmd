---
title: "Project 1-Jake Brophy, Zak Lang, James Chen, Wooin Lee"
author: "Jake Brophy, Zak Lang, James Chen, Wooin Lee"
date: "10/11/2021"
output: pdf_document
---
Data explanation:
A collection of Airbnb properties across the US, we have chosen to try and use the data provided to model which factors affect the price of an airbnb.

Variables:

price: The price of the Airbnb per night

number_of_reviews: The number of reviews on a listing

review_scores_value: The average review rating on a listing from 0-10 (10 being the best score)

cancellation_policy: The cancellation policy rated on how many days ahead of the stay you have to cancel for a full refund

host_for_x_days: How long the host has been listing their Airbnb

host_response_rate: Percent of time that the host responds to customers

accommodates: Number of people that can stay at the Airbnb

security_deposit: The price customers pay to Airbnb to secure their room

cleaning_fee: The price Airbnb charges to customers for cleaning fee 

minimum_nights: The minimum nights customers can stay 

maximum_nights: The maximum nights customers can stay 

Setup:
```{r setup, include=FALSE}
data <- read.csv('airbnb_listings.csv')
attach(data)
```

## R Markdown

Question 1: analysis

```{r cars}
library('tidyverse')
par(mfrow = (c(3,3)))
library(MASS)

fit <- fitdistr(price, densfun="normal")
hist(price, pch=20, breaks=25, prob = TRUE)
curve(dnorm(x, fit$estimate[1], fit$estimate[2]), col="blue", add=T)

fit2 <- fitdistr(number_of_reviews, densfun="normal")
hist(number_of_reviews, pch=20, breaks=25, prob = TRUE)
curve(dnorm(x, fit2$estimate[1], fit2$estimate[2]), col="blue", add=T)


fit3 <- fitdistr(review_scores_value, densfun="normal")
hist(review_scores_value, pch=20, breaks=25, prob = TRUE)
curve(dnorm(x, fit3$estimate[1], fit3$estimate[2]), col="blue", add=T)


fit4 <- fitdistr(cancellation_policy, densfun="normal")
hist(cancellation_policy, pch=20, breaks=25, prob = TRUE)
curve(dnorm(x, fit4$estimate[1], fit4$estimate[2]), col="blue", add=T)


fit5 <- fitdistr(host_for_x_days, densfun="normal")
hist(host_for_x_days, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit5$estimate[1], fit5$estimate[2]), col="blue", add=T)


fit6 <- fitdistr(accommodates, densfun="normal")
hist(accommodates, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit6$estimate[1], fit6$estimate[2]), col="blue", add=T)


fit7 <- fitdistr(security_deposit, densfun="normal")
hist(security_deposit, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit7$estimate[1], fit7$estimate[2]), col="blue", add=T)


fit8 <- fitdistr(cleaning_fee, densfun="normal")
hist(cleaning_fee, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit8$estimate[1], fit8$estimate[2]), col="blue", add=T)


fit9 <- fitdistr(minimum_nights, densfun="normal")
hist(minimum_nights, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit9$estimate[1], fit9$estimate[2]), col="blue", add=T)

fit10 <- fitdistr(maximum_nights, densfun="normal")
hist(maximum_nights, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit10$estimate[1], fit10$estimate[2]), col="blue", add=T)


fit11 <- fitdistr(host_response_rate, densfun="normal")
hist(host_response_rate, pch=30, breaks=40, prob = TRUE)
curve(dnorm(x, fit11$estimate[1], fit11$estimate[2]), col="blue", add=T)


```

The majority of prices are clustered around $100-$200 dollars, with more expensive
properties reaching upwards of $800-$1000

The majority of rentals have no review at all, with a few outliers that have as many as 300 reviews

From this plot we can see that the majority of people leave good reviews for the 
rentals they stay at, with the average being around a 9

From this we can see most properties have a cancellation policy of 3, suggesting that most have a fairly strict cancellation policy

There is a fairly equal distribution of how long a person has been a host for those who have been hosting 2000-3000 dayswith a drop off after that, with very few hosts having worked for more than 4000 days

We can see that most properties don't offer many accomodates, which could possibly suggest that those who do offer accomodates will be able to charge more

The range of security deposit seems to be narrow, with the vast majority being less than $1000

The most prevelant cleaning fee was around $50, with a fairly equal distribution until dropping off after $100

Most properties have a minimum nights of 0, suggesting that most hosts do not have a minimum number of nights a person has to stay

0 is also fairly prevalent here, suggesting that many hosts don't list a maximum night. The second most prevelant is around 1000, which suggests that those who do have a maximum stay nights are probably longer term rentals

Most hosts are very responsive and respond to all the emails they receive


```{r pressure, echo=FALSE}

plot(y = price, x = number_of_reviews)


plot(y = price, x = review_scores_value)


plot(y = price, x = cancellation_policy)


plot(y = price, x = host_for_x_days)


plot(y = price, x = accommodates)


plot(y = price, x = security_deposit)


plot(y = price, x = cleaning_fee)


plot(y = price, x = minimum_nights)


plot(y = price, x = maximum_nights)


plot(y = price, x = host_response_rate)



```

Does not seem to be much correlation between number of reviews and price, heteroscedacticity does seem to be present

There does seem to be some association between the quality of reviews and the price of a property

It seems like the most expensive properties tend to have the highest price

There does not seem to be much of a relationship between price and how long a person has been a host

It seems there is a positive relationship between the number of accomodates and price until there are 7 accomodates present, at which point it becomes more random

Most security deposits fall between $0 and $1000 so there are multiple different prices for any given security deposit

There seems to be a slightly positive relationship between the cleaning fee and price

The higher minimum nights properties have the lower their nightly prices tend to be

There does not seem to be much of a relationship between maximum nights and price

There seems to be a positive relationship between price and host response rate

```{r}
new_data <- subset(data, select = -c(name, host_id, host_name, 
                                     host_response_time, property_type, room_type))
boxplot(new_data$number_of_reviews, main = 'number of reviews')
boxplot(new_data$host_for_x_days, main = 'host for x days')
boxplot(new_data$review_scores_value, main = 'review scores value')
boxplot(new_data$security_deposit, main = 'security deposit')
boxplot(new_data$host_response_rate, main = 'host response rate')
boxplot(new_data$cancellation_policy, main = 'cancellation policy')
boxplot(new_data$accommodates, main = 'accommodates')
boxplot(new_data$cleaning_fee, main = 'cleaning fee')
boxplot(new_data$minimum_nights, main = 'minimum nights')
boxplot(new_data$maximum_nights, main = 'maximum nights')
```


number_of_reviews: This boxplot shows some outliers above 100 reviews. However, these are not removed as some places have have been hosting for a while and have a lot of reviews

review_scores_value: Although most Airbnb’s have good reviews, there are some with low reviews and these shouldn’t be eliminated. 

cancellation_policy: There are no outliers from this boxplot

host_for_x_days: Some hosts have been hosting for a long time, but these are not errors and the outliers have a particular meaning.

host_response_rate: The median of the data is around 90, which suggests that most of the hosts are responding to every request they receive, the ones that are not responding quickly are outliers.

accommodates: Some places are large venues that can host a lot of people. These outliers are important to the model.

Security_deposit: Removing a higher than $2000 high security deposit is necessary, as there are only 5 of such listings and the host may be trying to scam the tenant. 

cleaning_fee: No outliers are removed, as more expensive places may have greater fees.  
Minimum_nights:The majority of properties have very low or no minimum nights, so those with large minimum nights are outliers and should be removed

maximum_nights: This boxplot shows outliers greater than 8000 nights. These will be removed, as that is a very long time to stay somewhere and doesn’t exactly make sense. 



```{r}
library(corrplot)
library(RColorBrewer)
c <- cor(new_data)
corrplot(c)
```


The variables that seem to be most correlated with price are accomodates, security deposit, and cleaning fee.


Question 2: Baseline model

```{r}
lmmodel1 <- lm(price ~ number_of_reviews + review_scores_value + cancellation_policy
               +host_for_x_days+accommodates+security_deposit
               +cleaning_fee+minimum_nights+maximum_nights+host_response_rate, data = new_data)
summary(lmmodel1)
```


From this we can see that the variables that don't have statistical significance are maximum_nights, host_response_rate, number_of_reviews, and cancellation policy. We can also see that for minimum_nights, host_for_x_days, and number_of_reviews there is a negative coefficient, which means an increase in those variables is associated with a decrease in price that is on average equal to the value of the coefficient. The opposite can be said of the variables with a positive coefficient. We see that the largest estimates were for accommodates and review_scores_value, which makes sense because properties that can fit more accommodates are typically higher end and can charge more so , and the higher a review a property has, the more in demand they likely are and the more they can charge.

Question 3: Outliers

```{r}

boxplot(new_data$maximum_nights, plot=FALSE)$out
outliers <- boxplot(new_data$maximum_nights, plot=FALSE)$out
new_data<- new_data[-which(new_data$maximum_nights %in% outliers),]

boxplot(new_data$minimum_nights)$out
outliers2 <- boxplot(new_data$minimum_nights, plot=FALSE)$out
outliers2 <- outliers2[outliers2 >= 60]
new_data<- new_data[-which(new_data$minimum_nights %in% outliers2),]




```


We got rid of outliers in the maximum nights because very few properties offered stays for longer than 8000 days, and we removed outliers that in minimum nights becaues the majority of properties did not have a minimum night listed.

Question 4: Mallows CP and Boruta

```{r}
library(car)
library(leaps)
ss=regsubsets(price ~ number_of_reviews + review_scores_value + cancellation_policy
              +host_for_x_days+host_for_x_days+accommodates+price+security_deposit
              +cleaning_fee+minimum_nights+maximum_nights+host_response_rate, data = new_data, method=c("exhaustive"),nbest=3)
subsets(ss,statistic="cp",legend=F,main="Mallows CP",col="steelblue4", ylim = c(7,10))

library(Boruta)
Bor <- Boruta(price ~ number_of_reviews + review_scores_value + cancellation_policy
       +host_for_x_days+host_for_x_days+accommodates+price+security_deposit
       +cleaning_fee+minimum_nights+maximum_nights+host_response_rate, data = new_data)
attStats(Bor)
```


Based on this, we will keep review_scores_value, host_for_x_days, accommodates, security_deposit, cleaning_fee, and minimum_nights 

Question 5: VIF

```{r}
lmmodel2 <- lm(price~accommodates + security_deposit + cleaning_fee + minimum_nights + review_scores_value + host_for_x_days, data = new_data)
library(car)
vif(lmmodel2)
```


Multicollinearity shows moderate to high intercorrelations among independent variables; it leads to unstable estimates as it tends to increase the variances of regression coefficients. VIF > 10 indicates presence of multicollinearity. In our example, since all of our values are less than 5~10, we can conclude that these variables don't have multicollinearity issues.

Question 6: Residuals

```{r}
resid <- lmmodel2$residuals
plot(new_data$price, resid)
```


There's a very clear trend in the residuals which suggests that heteroskedasticity is present.

Question 7: RESET Test

```{r}
library(lmtest)
resettest(lmmodel2, power = 2, fit = 'regressor', data = new_data)
```


Question 8: Test for heteroskedasticity

```{r}
ncvTest(lmmodel2)
bptest(lmmodel2)

```

With a p-value of 2.22e-16 and 2.2e-16 we can assume that heteroskedasticity is present in our dataset

Question 9: GLS estimator

```{r}
ehatsq <- residuals(lmmodel2)^2
sighatsq.ols  <-  lm(log(ehatsq)~log(sqrt(accommodates)) + log(security_deposit) + log(cleaning_fee) + log(minimum_nights) + log(review_scores_value) + log(host_for_x_days), data = new_data, na.action = na.exclude)
vari <- exp(fitted(sighatsq.ols))
regmod.fgls <- lm(price~sqrt(accommodates) + security_deposit + cleaning_fee + minimum_nights + review_scores_value + host_for_x_days, data = new_data)
summary(regmod.fgls)
```

```{r}
BIC(regmod.fgls, lmmodel1, lmmodel2)
AIC(regmod.fgls, lmmodel1, lmmodel2)

```

Our adjusted model has a lower AIC and BIC than either of our previous models so this is the model we will use.

```{r}
set.seed(1)
row.number <- sample(1:nrow(new_data), 0.75*nrow(new_data))
train = new_data[row.number,]
test = new_data[-row.number,]
dim(train)
dim(test)
sqrt(mean((train$price - predict(regmod.fgls, train)) ^ 2))
sqrt(mean((test$price - predict(regmod.fgls, test)) ^ 2))
library(lmvar)
fit= lm(price~sqrt(accommodates) + security_deposit + cleaning_fee + minimum_nights + review_scores_value + host_for_x_days, data = new_data, weights=1/vari,x = TRUE, y = TRUE)
cv.lm(fit, k = 5)
```


Our training values were off by on average 87.5274 and our testing values were off by an average of 76.59972. Our root mean squared error was 85.33386 which is how far our values were off in an out of model scenario.


Conclusion:
Overall, we were able to produce a model that improved upon our baseline simple linear regression model. We did so by evaluating which variables were relevant to the model, then removing outliers, testing for heteroskedasticity, and then using GLS estimator with an unknown form of variance to produce a model that had homoskedastic errors to account for this heteroskedasticity. Then we added a higher order term to better model the data for the accommodates variable. The improvement of this model over the previous attempts was reflected in the AIC and BIC. Finally, using cross-validation and train-test-split, we evaluated how our model performed. 
From the summary of the final regression, it can be seen that the variable square root of accommodates has a large effect on the price. This is approximately $92 for every additional root(person that the listing holds). All variables are significant. The cleaning fee, security deposit and review score all have a positive effect on the price of the listing. Whereas, the minimum number of nights and how long the host has been hosting have negative effects on the price. Security fee and cleaning fee are expected to be positively correlated with price, as more expensive listings are probably nicer (more expensive to fix) and cost more to clean. Review score also likely is positively correlated for supply and demand reasons (higher rated listings are able to charge a higher price, as demand is increased). High minimum number of nights is correlated with a lower price. This is likely due to common pricing strategies. For example, people are willing to pay a high price per night if they are staying short term in a hotel, but for apartments the  price is normally cheaper per night and people stay longer. From our determined regression, if a client has a property that they would like to put on Airbnb, the going rate can be determined by the number of people it accommodates, the price of security deposit, cleaning fee, minimum number of nights one can stay, average review score and how long the host has been working with Airbnb. Additionally, if the client wants to increase the price they charge at their property, it would be worthwhile to increase the number of people it accommodates, decrease the minimum number of nights or increase their average review score. 

